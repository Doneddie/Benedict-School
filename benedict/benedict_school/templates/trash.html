from formtools.wizard.views import SessionWizardView
from django.forms import modelformset_factory

{% block content %}
    <h1>Register Children for {{ parent.first_name }} {{ parent.last_name }}</h1>

    <!-- Display the child registration forms and application forms -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Render Child Forms -->
        {{ child_formset.management_form }}
        {% for form in child_formset %}
            <fieldset>
                <legend>Child {{ forloop.counter }}</legend>
                {{ form.as_p }}
            </fieldset>
        {% endfor %}
        
        <!-- Render PupilApplication Forms -->
        {{ application_formset.management_form }}
        {% for form in application_formset %}
            <fieldset>
                <legend>Application for Child {{ forloop.counter }}</legend>
                {{ form.as_p }}
            </fieldset>
        {% endfor %}
        
        <button type="submit">Submit</button>
    </form>
{% endblock %}

def register_children(request, parent_id):
    parent = Parent.objects.get(id=parent_id)

    # Get the number of children to register (from the parent object, not from a POST or GET request)
    num_children = parent.num_children 
    
    # Create formsets based on the number of children
    ChildFormSet = formset_factory(ChildForm, extra=num_children)
    PupilApplicationFormSet = formset_factory(PupilApplicationForm, extra=num_children)

    if request.method == 'POST':
        child_formset = ChildFormSet(request.POST, request.FILES, prefix='child')
        application_formset = PupilApplicationFormSet(request.POST, request.FILES, prefix='application')

        if child_formset.is_valid() and application_formset.is_valid():
            for child_form, application_form in zip(child_formset, application_formset):
                child = child_form.save(commit=False)
                child.parent = parent
                child.save()
                application = application_form.save(commit=False)
                application.child = child
                application.save()

            return redirect('success_page')  # Redirect to a success page or wherever you need

    else:
        child_formset = ChildFormSet(prefix='child')
        application_formset = PupilApplicationFormSet(prefix='application')

    context = {
        'parent': parent,
        'child_formset': child_formset,
        'application_formset': application_formset,
    }
    return render(request, 'register_children.html', context)